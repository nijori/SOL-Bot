name: Security Scan

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]
    paths:
      - 'package.json'
      - 'package-lock.json'
      - 'yarn.lock'
      - '.github/workflows/security-scan.yml'
  schedule:
    - cron: '0 0 * * *' # æ¯æ—¥UTCã®0:00ã«å®Ÿè¡Œï¼ˆå…¨ä½“ã‚¹ã‚­ãƒ£ãƒ³ï¼‰
    - cron: '0 1 * * 1' # æ¯é€±æœˆæ›œæ—¥AM 1:00ï¼ˆUTCï¼‰ã«å®Ÿè¡Œï¼ˆè©³ç´°è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³ï¼‰
  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  workflow_dispatch:
    inputs:
      severity:
        description: 'ã‚¹ã‚­ãƒ£ãƒ³é‡å¤§åº¦ï¼ˆCRITICAL,HIGH,MEDIUM,LOWï¼‰'
        required: false
        default: 'CRITICAL,HIGH'

jobs:
  secrets-scan:
    name: Secrets Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 # å…¨å±¥æ­´ã‚’ãƒ•ã‚§ãƒƒãƒ

      - name: Gitleaks Scan
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}
        with:
          config-path: .gitleaks.toml

  dependency-scan:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Setup Trivy
        run: |
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main | sudo tee -a /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install trivy -y

      # è©³ç´°ã‚¹ã‚­ãƒ£ãƒ³ã®å®Ÿè¡Œ
      - name: Run Trivy vulnerability scanner (Detailed)
        run: |
          # æ‰‹å‹•å®Ÿè¡Œæ™‚ã¯inputsã‚’ä½¿ç”¨ã€ãã‚Œä»¥å¤–ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š
          SEVERITY="${{ github.event.inputs.severity || 'CRITICAL,HIGH' }}"

          # è©³ç´°ãªè„†å¼±æ€§æƒ…å ±ã‚’å«ã‚€JSONãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ
          trivy fs --format json -o trivy-results.json \
            --severity $SEVERITY \
            --ignore-unfixed=false \
            --vuln-type os,library \
            .

          # GitHubã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ç”¨ã®SARIFãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ
          trivy fs --format sarif -o trivy-sarif.json \
            --severity $SEVERITY \
            --ignore-unfixed=false \
            --vuln-type os,library \
            .

          # èª­ã¿ã‚„ã™ã„ãƒ†ãƒ¼ãƒ–ãƒ«å½¢å¼ã§ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã«è¡¨ç¤º
          trivy fs --severity $SEVERITY \
            --ignore-unfixed=false \
            .

      # GitHub Security Alertsã¸ã®çµ±åˆ
      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: trivy-sarif.json
          category: trivy

      # è„†å¼±æ€§ãŒæ¤œå‡ºã•ã‚ŒãŸå ´åˆã€PRã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ 
      - name: Comment PR with vulnerability summary
        if: github.event_name == 'pull_request' && github.event.pull_request.head.repo.fork == false
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const trivyResults = JSON.parse(fs.readFileSync('trivy-results.json', 'utf8'));

            // è„†å¼±æ€§ã®é›†è¨ˆ
            let criticalCount = 0;
            let highCount = 0;
            let mediumCount = 0;
            let lowCount = 0;

            trivyResults.Results.forEach(result => {
              if (result.Vulnerabilities) {
                result.Vulnerabilities.forEach(vuln => {
                  if (vuln.Severity === 'CRITICAL') criticalCount++;
                  if (vuln.Severity === 'HIGH') highCount++;
                  if (vuln.Severity === 'MEDIUM') mediumCount++;
                  if (vuln.Severity === 'LOW') lowCount++;
                });
              }
            });

            // è©³ç´°ãªè„†å¼±æ€§æƒ…å ±ã®æŠ½å‡ºï¼ˆä¸Šä½5ä»¶ã¾ã§ï¼‰
            let topVulns = [];
            let vulnCount = 0;

            for (const result of trivyResults.Results) {
              if (result.Vulnerabilities) {
                for (const vuln of result.Vulnerabilities) {
                  if (vuln.Severity === 'CRITICAL' || vuln.Severity === 'HIGH') {
                    if (vulnCount < 5) {
                      topVulns.push(`- **${vuln.PkgName}@${vuln.InstalledVersion}**: ${vuln.VulnerabilityID} (${vuln.Severity}) - ${vuln.Title}`);
                      vulnCount++;
                    }
                  }
                }
              }
            }

            // PRã‚³ãƒ¡ãƒ³ãƒˆã®ä½œæˆ
            let comment = `## Trivy Security Scan ğŸ”\n\n`;
            comment += `**æ¤œå‡ºã•ã‚ŒãŸè„†å¼±æ€§:**\n`;
            comment += `- Critical: ${criticalCount}\n`;
            comment += `- High: ${highCount}\n`;
            comment += `- Medium: ${mediumCount}\n`;
            comment += `- Low: ${lowCount}\n\n`;

            if (criticalCount > 0 || highCount > 0) {
              comment += `### ä¸»è¦ãªè„†å¼±æ€§:\n${topVulns.join('\n')}\n\n`;
              comment += `âš ï¸ é‡å¤§ãªè„†å¼±æ€§ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚ãƒãƒ¼ã‚¸å‰ã«å¯¾å¿œã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚\n`;
            } else {
              comment += `âœ… é‡å¤§ãªè„†å¼±æ€§ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚\n`;
            }

            comment += `\nè©³ç´°ã¯GitHub Security Advisoriesã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      # æˆæœç‰©ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      - name: Upload vulnerability report
        uses: actions/upload-artifact@v4
        with:
          name: trivy-vulnerability-report
          path: trivy-results.json

  sbom-generation:
    name: SBOM Generation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Setup Trivy
        run: |
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main | sudo tee -a /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install trivy -y

      - name: Generate SBOM with CycloneDX
        uses: CycloneDX/gh-node-module-generatebom@master
        with:
          path: ./
          output: ./bom.xml

      - name: Upload SBOM artifact
        uses: actions/upload-artifact@v4
        with:
          name: cyclonedx-sbom
          path: ./bom.xml

      - name: Verify SBOM file exists
        run: |
          if [ -f "./bom.xml" ]; then
            echo "SBOM file found: ./bom.xml"
            ls -la ./bom.xml
            head -10 ./bom.xml
          else
            echo "SBOM file not found!"
            exit 1
          fi

      - name: Analyze SBOM with Trivy
        run: |
          # Trivyã‚’ä½¿ã£ã¦SBOMãƒ•ã‚¡ã‚¤ãƒ«ã‚’è§£æ
          trivy sbom ./bom.xml --format table --exit-code 0 || echo "SBOM analysis completed with warnings"

  security-report:
    name: Security Report Generation
    needs: [secrets-scan, dependency-scan, sbom-generation]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Generate Security Report
        run: |
          echo "# Security Scan Report" > security-report.md
          echo "## Scan Date: $(date)" >> security-report.md
          echo "## Overview" >> security-report.md

          if [ "${{ needs.secrets-scan.result }}" == "success" ]; then
            echo "- âœ… Secrets Scan: PASSED" >> security-report.md
          else
            echo "- âŒ Secrets Scan: FAILED" >> security-report.md
          fi

          if [ "${{ needs.dependency-scan.result }}" == "success" ]; then
            echo "- âœ… Dependency Scan: PASSED" >> security-report.md
          else
            echo "- âŒ Dependency Scan: FAILED" >> security-report.md
          fi

          if [ "${{ needs.sbom-generation.result }}" == "success" ]; then
            echo "- âœ… SBOM Generation: PASSED" >> security-report.md
          else
            echo "- âŒ SBOM Generation: FAILED" >> security-report.md
          fi

          echo "## Recommendations" >> security-report.md
          echo "- Keep dependencies up to date" >> security-report.md
          echo "- Review SBOM for any deprecated packages" >> security-report.md
          echo "- Ensure proper secrets management" >> security-report.md

      - name: Upload Security Report
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: ./security-report.md
