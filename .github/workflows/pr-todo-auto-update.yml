name: PR ãƒãƒ¼ã‚¸æ™‚ã®Todoã‚¿ã‚¹ã‚¯è‡ªå‹•æ›´æ–°

on:
  pull_request:
    types: [closed]
    branches: [master, main]

jobs:
  update-todo-on-merge:
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true

    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: ã‚¿ã‚¹ã‚¯IDã‚’æŠ½å‡ºã—ã¦é€²æ—çŠ¶æ³ã‚’æ›´æ–°
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_BODY="${{ github.event.pull_request.body }}"

          echo "PRã‚¿ã‚¤ãƒˆãƒ«: $PR_TITLE"

          # ã‚¿ã‚¹ã‚¯IDã®ãƒ‘ã‚¿ãƒ¼ãƒ³ [A-Z]{3}-[0-9]{3}
          if [[ $PR_TITLE =~ ([A-Z]{3}-[0-9]{3}) ]]; then
            TASK_ID="${BASH_REMATCH[1]}"
          elif [[ $PR_BODY =~ (Fixes|Closes|Related to|Resolves) ([A-Z]{3}-[0-9]{3}) ]]; then
            TASK_ID="${BASH_REMATCH[2]}"
          else
            echo "PRã‚¿ã‚¤ãƒˆãƒ«ã¾ãŸã¯ãƒœãƒ‡ã‚£ã‹ã‚‰ã‚¿ã‚¹ã‚¯IDã‚’è¦‹ã¤ã‘ã‚‰ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚å‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
            exit 0
          fi

          echo "è¦‹ã¤ã‹ã£ãŸã‚¿ã‚¹ã‚¯ID: $TASK_ID"

          # Gitèªè¨¼æƒ…å ±ã®è¨­å®š
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

          # ã™ã¹ã¦ã®Todoãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆsprint.mdcã€backlog.mdcï¼‰ã‚’æ¤œç´¢
          TODO_FILES=(".todo/sprint.mdc" ".todo/backlog.mdc")

          TASK_UPDATED=0

          for FILE in "${TODO_FILES[@]}"; do
            if [ ! -f "$FILE" ]; then
              echo "$FILE ãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚"
              continue
            fi
            
            # ãƒ•ã‚¡ã‚¤ãƒ«å†…ã§ä¸€è‡´ã™ã‚‹ã‚¿ã‚¹ã‚¯IDè¡Œã‚’æ¤œç´¢
            LINE_NUM=$(grep -n "- \[ \] $TASK_ID:" "$FILE" | cut -d ":" -f 1)
            
            if [ -n "$LINE_NUM" ]; then
              echo "$FILE ã® $LINE_NUM è¡Œç›®ã§ã‚¿ã‚¹ã‚¯ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ"
              
              # ã‚¿ã‚¹ã‚¯ãŒæœªå®Œäº†ã®å ´åˆã¯é€²æ—ã‚’æ›´æ–°
              sed -i "${LINE_NUM}s/- \[ \]/- \[x\]/" "$FILE"
              
              # Healthã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’âœ…ã«æ›´æ–°
              HEALTH_LINE=$(grep -n "ğŸ©º Health     :" "$FILE" | grep -A 10 -B 10 "$TASK_ID" | head -n 1 | cut -d ":" -f 1)
              if [ -n "$HEALTH_LINE" ]; then
                sed -i "${HEALTH_LINE}s/ğŸ©º Health     : .*/ğŸ©º Health     : âœ…/" "$FILE"
              fi
              
              # Progressã‚’100%ã«æ›´æ–°
              PROGRESS_LINE=$(grep -n "ğŸ“Š Progress   :" "$FILE" | grep -A 10 -B 10 "$TASK_ID" | head -n 1 | cut -d ":" -f 1)
              if [ -n "$PROGRESS_LINE" ]; then
                sed -i "${PROGRESS_LINE}s/ğŸ“Š Progress   : .*/ğŸ“Š Progress   : 100%/" "$FILE"
              fi
              
              echo "$TASK_ID: ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒå®Œäº†ã«æ›´æ–°ã•ã‚Œã¾ã—ãŸ"
              TASK_UPDATED=1
            fi
          done

          if [ $TASK_UPDATED -eq 1 ]; then
            # å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆ
            git add .todo/*.mdc
            
            # å¤‰æ›´ãŒã‚ã‚‹å ´åˆã®ã¿ã‚³ãƒŸãƒƒãƒˆ
            if git diff --staged --quiet; then
              echo "å¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚"
            else
              git commit -m "ğŸ¤– $TASK_ID: PRãƒãƒ¼ã‚¸ã«ã‚ˆã‚‹è‡ªå‹•ã‚¿ã‚¹ã‚¯å®Œäº†æ›´æ–°"
              git push
              echo "ã‚¿ã‚¹ã‚¯ $TASK_ID ãŒè‡ªå‹•çš„ã«å®Œäº†ã¨ã—ã¦ãƒãƒ¼ã‚¯ã•ã‚Œã¾ã—ãŸã€‚"
            fi
          else
            echo "æ›´æ–°ã™ã‚‹ã‚¿ã‚¹ã‚¯ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚"
          fi
