name: Trivy Dependency Vulnerability Scan

on:
  # é€±æ¬¡ã§ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œ
  schedule:
    - cron: '0 1 * * 1' # æ¯é€±æœˆæ›œæ—¥AM 1:00ï¼ˆUTCï¼‰ã«å®Ÿè¡Œ

  # Pull Requestã§ã‚‚å®Ÿè¡Œ
  pull_request:
    branches: [main, master]
    paths:
      - 'package.json'
      - 'package-lock.json'
      - 'yarn.lock'

  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  workflow_dispatch:
    inputs:
      severity:
        description: 'ã‚¹ã‚­ãƒ£ãƒ³é‡å¤§åº¦ï¼ˆCRITICAL,HIGH,MEDIUM,LOWï¼‰'
        required: false
        default: 'CRITICAL,HIGH'

jobs:
  vulnerability-scan:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Setup Trivy
        run: |
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main | sudo tee -a /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install trivy -y

      # è©³ç´°ã‚¹ã‚­ãƒ£ãƒ³ã®å®Ÿè¡Œ
      - name: Run Trivy vulnerability scanner (Detailed)
        run: |
          # æ‰‹å‹•å®Ÿè¡Œæ™‚ã¯inputsã‚’ä½¿ç”¨ã€ãã‚Œä»¥å¤–ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š
          SEVERITY="${{ github.event.inputs.severity || 'CRITICAL,HIGH' }}"

          # è©³ç´°ãªè„†å¼±æ€§æƒ…å ±ã‚’å«ã‚€JSONãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ
          trivy fs --format json -o trivy-results.json \
            --severity $SEVERITY \
            --ignore-unfixed=false \
            --vuln-type os,library \
            .

          # GitHubã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ç”¨ã®SARIFãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆ
          trivy fs --format sarif -o trivy-sarif.json \
            --severity $SEVERITY \
            --ignore-unfixed=false \
            --vuln-type os,library \
            .

          # èª­ã¿ã‚„ã™ã„ãƒ†ãƒ¼ãƒ–ãƒ«å½¢å¼ã§ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã«è¡¨ç¤º
          trivy fs --severity $SEVERITY \
            --ignore-unfixed=false \
            .

      # GitHub Security Alertsã¸ã®çµ±åˆ
      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-sarif.json
          category: trivy

      # è„†å¼±æ€§ãŒæ¤œå‡ºã•ã‚ŒãŸå ´åˆã€PRã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ 
      - name: Comment PR with vulnerability summary
        if: github.event_name == 'pull_request' && github.event.pull_request.head.repo.fork == false
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const trivyResults = JSON.parse(fs.readFileSync('trivy-results.json', 'utf8'));

            // è„†å¼±æ€§ã®é›†è¨ˆ
            let criticalCount = 0;
            let highCount = 0;
            let mediumCount = 0;
            let lowCount = 0;

            trivyResults.Results.forEach(result => {
              if (result.Vulnerabilities) {
                result.Vulnerabilities.forEach(vuln => {
                  if (vuln.Severity === 'CRITICAL') criticalCount++;
                  if (vuln.Severity === 'HIGH') highCount++;
                  if (vuln.Severity === 'MEDIUM') mediumCount++;
                  if (vuln.Severity === 'LOW') lowCount++;
                });
              }
            });

            // è©³ç´°ãªè„†å¼±æ€§æƒ…å ±ã®æŠ½å‡ºï¼ˆä¸Šä½5ä»¶ã¾ã§ï¼‰
            let topVulns = [];
            let vulnCount = 0;

            for (const result of trivyResults.Results) {
              if (result.Vulnerabilities) {
                for (const vuln of result.Vulnerabilities) {
                  if (vuln.Severity === 'CRITICAL' || vuln.Severity === 'HIGH') {
                    if (vulnCount < 5) {
                      topVulns.push(`- **${vuln.PkgName}@${vuln.InstalledVersion}**: ${vuln.VulnerabilityID} (${vuln.Severity}) - ${vuln.Title}`);
                      vulnCount++;
                    }
                  }
                }
              }
            }

            // PRã‚³ãƒ¡ãƒ³ãƒˆã®ä½œæˆ
            let comment = `## Trivy Security Scan ğŸ”\n\n`;
            comment += `**æ¤œå‡ºã•ã‚ŒãŸè„†å¼±æ€§:**\n`;
            comment += `- Critical: ${criticalCount}\n`;
            comment += `- High: ${highCount}\n`;
            comment += `- Medium: ${mediumCount}\n`;
            comment += `- Low: ${lowCount}\n\n`;

            if (criticalCount > 0 || highCount > 0) {
              comment += `### ä¸»è¦ãªè„†å¼±æ€§:\n${topVulns.join('\n')}\n\n`;
              comment += `âš ï¸ é‡å¤§ãªè„†å¼±æ€§ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚ãƒãƒ¼ã‚¸å‰ã«å¯¾å¿œã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚\n`;
            } else {
              comment += `âœ… é‡å¤§ãªè„†å¼±æ€§ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚\n`;
            }

            comment += `\nè©³ç´°ã¯GitHub Security Advisoriesã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      # æˆæœç‰©ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      - name: Upload vulnerability report
        uses: actions/upload-artifact@v3
        with:
          name: trivy-vulnerability-report
          path: trivy-results.json
