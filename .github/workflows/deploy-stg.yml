name: Deploy to Staging

on:
  push:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      reason:
        description: '手動デプロイの理由'
        required: true
        default: 'ステージング環境テスト'

permissions:
  id-token: write
  contents: read

jobs:
  test-and-deploy:
    runs-on: ubuntu-latest
    environment: staging

    steps:
      - name: チェックアウト
        uses: actions/checkout@v4

      - name: Node.jsセットアップ
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: 依存関係のインストール
        run: npm ci

      - name: Jestによるテスト実行
        run: npm test

      # TypeScriptビルドは一時的に無効化（CommonJS移行中のため）
      # - name: TypeScriptのビルド
      #   run: npm run build

      - name: GitHub Context Debug
        run: |
          echo "Repository: ${{ github.repository }}"
          echo "Ref: ${{ github.ref }}"
          echo "Actor: ${{ github.actor }}"
          echo "Expected sub: repo:${{ github.repository }}:ref:${{ github.ref }}"

      - name: AWS認証設定
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::475538532274:role/solbot-ci
          aws-region: ap-northeast-1

      - name: ステージング環境ファイル作成
        run: |
          echo "NODE_ENV=staging" > .env
          echo "LOG_LEVEL=debug" >> .env
          echo "API_PORT=3000" >> .env
          echo "# 機密情報は後でSSM Parameter Storeから取得予定" >> .env

      - name: ステージングEC2へのファイル転送
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ec2-13-158-58-241.ap-northeast-1.compute.amazonaws.com
          username: ec2-user
          key: ${{ secrets.STG_SSH_KEY }}
          source: '.,!node_modules,!.git,!__tests__,!logs,!data'
          target: '/tmp/solbot-deploy-${{ github.sha }}'
          strip_components: 0

      - name: ステージング環境デプロイ実行
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ec2-13-158-58-241.ap-northeast-1.compute.amazonaws.com
          username: ec2-user
          key: ${{ secrets.STG_SSH_KEY }}
          script: |
            set -e
            
            echo "=== SOL Bot Staging Deployment ==="
            echo "Commit: ${{ github.sha }}"
            echo "Triggered by: ${{ github.actor }}"
            echo "Timestamp: $(date)"
            echo ""
            
            # Move files to deployment directory
            sudo mkdir -p /opt/solbot
            sudo cp -r /tmp/solbot-deploy-${{ github.sha }}/* /opt/solbot/
            sudo chown -R ec2-user:ec2-user /opt/solbot
            
            # Install systemd service if not exists
            if [ ! -f "/etc/systemd/system/bot.service" ]; then
              echo "Installing systemd service..."
              sudo cp /opt/solbot/infra/systemd/bot.service /etc/systemd/system/
              sudo systemctl daemon-reload
              sudo systemctl enable bot.service
            fi
            
            # Create solbot user if not exists
            if ! id "solbot" &>/dev/null; then
              echo "Creating solbot user..."
              sudo useradd --system --home /opt/solbot --shell /bin/bash solbot
            fi
            
            # Set proper ownership
            sudo chown -R solbot:solbot /opt/solbot
            
            # Clean up any existing Node.js installations and install fresh
            echo "Cleaning up existing Node.js installations..."
            
            # Wait for any existing yum operations to complete
            echo "Waiting for any existing yum locks to clear..."
            sudo fuser -k /var/run/yum.pid 2>/dev/null || true
            sleep 2
            
            # Remove NVM and its Node.js installations
            if [ -d "$HOME/.nvm" ]; then
              echo "Removing NVM installation..."
              rm -rf "$HOME/.nvm"
            fi
            
            # Remove any existing Node.js/npm symlinks
            sudo rm -f /usr/local/bin/node /usr/local/bin/npm
            
            # Remove from PATH any NVM references
            export PATH=$(echo $PATH | sed 's|[^:]*\.nvm[^:]*:||g')
            
            # Check available Amazon Linux Extras topics and install appropriate Node.js
            echo "Checking available Node.js topics in Amazon Linux Extras..."
            sudo amazon-linux-extras list | grep -i node || echo "No node topics found"
            
            # Try different Node.js installation methods in order of preference
            if sudo amazon-linux-extras list | grep -q "nodejs18"; then
              echo "Installing Node.js 18 via Amazon Linux Extras..."
              sudo amazon-linux-extras install nodejs18 -y
            elif sudo amazon-linux-extras list | grep -q "nodejs16"; then
              echo "Installing Node.js 16 via Amazon Linux Extras..."
              sudo amazon-linux-extras install nodejs16 -y
            elif sudo amazon-linux-extras list | grep -q "nodejs14"; then
              echo "Installing Node.js 14 via Amazon Linux Extras..."
              sudo amazon-linux-extras install nodejs14 -y
            else
              echo "No Node.js topics found in Amazon Linux Extras, trying alternative methods..."
              
              # Method 1: Direct binary installation for maximum compatibility
              echo "Installing Node.js 14 binary (compatible with Amazon Linux 2 glibc 2.26)..."
              cd /tmp
              
              # Remove any existing Node.js packages that might cause conflicts
              sudo yum remove -y nodejs npm nodesource-release nsolid* 2>/dev/null || true
              
              # Download and install Node.js 14.21.3 binary
              echo "Downloading Node.js 14.21.3 binary..."
              wget -q https://nodejs.org/dist/v14.21.3/node-v14.21.3-linux-x64.tar.xz
              
              echo "Installing Node.js binary to /usr/local..."
              sudo tar -C /usr/local --strip-components 1 -xJf node-v14.21.3-linux-x64.tar.xz
              
              # Create symlinks
              sudo ln -sf /usr/local/bin/node /usr/bin/node
              sudo ln -sf /usr/local/bin/npm /usr/bin/npm
              sudo ln -sf /usr/local/bin/npx /usr/bin/npx
              
              # Verify binary compatibility
              echo "Verifying Node.js installation compatibility..."
              ldd /usr/local/bin/node | grep GLIBC || echo "No GLIBC dependencies shown"
              
              cd -
              
              # If binary installation fails, try alternative methods
              if ! command -v node &> /dev/null; then
                echo "Binary installation failed, trying EPEL with older Node.js..."
                
                # Install EPEL if not already installed
                if ! sudo amazon-linux-extras list | grep -q "epel.*enabled"; then
                  sudo amazon-linux-extras install epel -y
                fi
                
                # Try to find and install compatible Node.js version from EPEL
                echo "Searching for compatible Node.js in EPEL..."
                sudo yum search nodejs --enablerepo=epel | head -20
                
                # Try installing specific older version if available
                sudo yum install -y nodejs-6* npm-3* --enablerepo=epel 2>/dev/null || {
                  echo "No compatible Node.js found in EPEL, using latest available..."
                  sudo yum install -y nodejs npm --enablerepo=epel --skip-broken || true
                }
              fi
            fi
            
            # Ensure npm is installed
            if ! command -v npm &> /dev/null; then
              echo "npm not found, installing npm separately..."
              sudo yum install -y npm
            fi
            
            # Verify installation
            echo "Node.js version: $(node --version)"
            echo "npm version: $(npm --version)"
            echo "Node.js path: $(which node)"
            echo "npm path: $(which npm)"
            
            # Install dependencies
            cd /opt/solbot
            
            # Verify npm is available
            echo "Verifying npm availability..."
            which npm
            npm --version
            
            # Clean solbot user environment and install dependencies
            echo "Installing dependencies as solbot user..."
            sudo -u solbot bash -c '
              # Clean any NVM references from solbot user
              export PATH="/usr/bin:/usr/local/bin:$PATH"
              unset NVM_DIR
              echo "solbot user - Node.js path: $(which node)"
              echo "solbot user - npm path: $(which npm)"
              echo "solbot user - Node.js version: $(node --version)"
              echo "solbot user - npm version: $(npm --version)"
              npm ci --production
            '
            
            # Build TypeScript (一時的に無効化 - CommonJS移行中)
            # sudo -u solbot npm run build || echo "Warning: Build failed or no build script"
            
            # Stop service if running
            if sudo systemctl is-active --quiet bot.service; then
              echo "Stopping bot.service..."
              sudo systemctl stop bot.service
              sleep 2
            fi
            
            # Start service
            echo "Starting bot.service..."
            sudo systemctl start bot.service
            
            # Wait for service to start
            sleep 5
            
            # Check service status
            if sudo systemctl is-active --quiet bot.service; then
              echo "✓ Service started successfully"
              sudo systemctl status bot.service --no-pager -l
            else
              echo "✗ Service failed to start"
              sudo systemctl status bot.service --no-pager -l
              sudo journalctl -u bot -n 20 --no-pager
              exit 1
            fi

      - name: ヘルスチェック実行
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ec2-13-158-58-241.ap-northeast-1.compute.amazonaws.com
          username: ec2-user
          key: ${{ secrets.STG_SSH_KEY }}
          script: |
            set -e
            
            echo "=== Health Check ==="
            
            # Wait for application to be ready
            echo "Waiting for application to be ready..."
            for i in {1..30}; do
              if curl -f -s http://localhost:3000/api/status > /dev/null; then
                echo "✓ Application is responding"
                break
              fi
              echo "Attempt $i/30: Application not ready yet..."
              sleep 2
            done
            
            # Perform health check
            echo "Performing detailed health check..."
            HEALTH_RESPONSE=$(curl -s http://localhost:3000/api/status || echo "FAILED")
            
            if [ "$HEALTH_RESPONSE" = "FAILED" ]; then
              echo "✗ Health check failed - no response"
              exit 1
            fi
            
            echo "Health check response:"
            echo "$HEALTH_RESPONSE" | jq . || echo "$HEALTH_RESPONSE"
            
            # Verify response contains expected fields
            if echo "$HEALTH_RESPONSE" | jq -e '.status' > /dev/null; then
              STATUS=$(echo "$HEALTH_RESPONSE" | jq -r '.status')
              echo "✓ Status: $STATUS"
              
              if [ "$STATUS" = "running" ]; then
                echo "✓ Health check passed - service is running"
              else
                echo "⚠ Warning: Service status is '$STATUS' (expected 'running')"
              fi
            else
              echo "⚠ Warning: Health response missing 'status' field"
            fi
            
            echo "=== Deployment Successful ==="

      - name: クリーンアップ
        if: always()
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ec2-13-158-58-241.ap-northeast-1.compute.amazonaws.com
          username: ec2-user
          key: ${{ secrets.STG_SSH_KEY }}
          script: |
            # Clean up temporary deployment files
            sudo rm -rf /tmp/solbot-deploy-${{ github.sha }}
            echo "✓ Cleaned up temporary files"

      - name: Discordへの通知
        uses: sarisia/actions-status-discord@v1
        if: always()
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_URL }}
          status: ${{ job.status }}
          title: 'SOL-Bot ステージングデプロイ'
          description: |
            リポジトリ: ${{ github.repository }}
            コミット: ${{ github.sha }}
            ブランチ: ${{ github.ref_name }}
            トリガー: ${{ github.actor }}
            ${{ github.event_name == 'workflow_dispatch' && format('理由: {0}', github.event.inputs.reason) || '' }}
            
            ステージング環境: ec2-13-158-58-241.ap-northeast-1.compute.amazonaws.com 