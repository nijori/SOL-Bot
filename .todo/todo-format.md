# SOL-Bot Todo形式ガイドライン

## 1. フォルダ & ファイル構成

```
repo-root/
 └── .todo/
      ├──  backlog.mdc    # 未着手タスク (inbox)
      ├──  sprint.mdc     # 今スプリントの WIP/Done
      ├──  todo-format.md # 本ガイドライン
      └──  archive.mdc    # 完了 3 ヵ月後にここへ移動
```

## 2. タスク行フォーマット

```
- [ ] TASK‑ID: <短いタイトル>  ← 1 行目は見出し
      - 📅 Due        : YYYY‑MM‑DD
      - 👤 Owner      : <GitHub ユーザー or @slack>
      - 🔗 Depends-on : TASK‑ID1, TASK‑ID2 ... (省略可)
      - 🏷️  Label      : bug / feat / doc / infra / test
      - 🩺 Health     : ⏳ / ⚠️ / 🚑 / ✅
      - 📊 Progress   : 0% / 25% / 50% / 75% / 100%
      - ✎ Notes      : (自由メモ 120 字以内)
```

## 3. フィールド説明

| フィールド | 説明 |
|------------|------|
| TASK‑ID    | カテゴリ3文字 + ハイフン + 3桁連番 (例: `ALG-001`) |
| Owner      | 担当者のGitHubユーザー名・Slackアカウント |
| Depends-on | 依存するタスクID（カンマ区切りで複数可）|
| Label      | タスクの種類: `feat`/`bug`/`doc`/`infra`/`test` |
| Health     | ⏳=WIP, ⚠️=遅延気味, 🚑=要救援, ✅=完了 |
| Progress   | 作業の進捗状況をパーセント表示 |
| Notes      | タスクの詳細、実装メモなど |

## 4. カテゴリ接頭辞一覧

| 接頭辞 | 意味 |
|--------|------|
| DAT    | データ収集・ETL |
| ALG    | 売買ロジック／バックテスト |
| OMS    | 発注・OMS 実装 |
| INF    | インフラ・CI/CD |
| CONF   | 設定関連 |
| OPT    | 最適化関連 |
| DOC    | ドキュメント |
| TST    | テスト |
| CICD   | CI/CD関連 |
| DEP    | 依存関係・パッケージ |
| BT     | バックテスト関連 |
| RISK   | リスク管理関連 |
| PERF   | パフォーマンス最適化 |
| SEC    | セキュリティ関連 |

## 5. ライフサイクル・ルール

1. **新規作成**: backlog.mdc に追加。Health = ⏳
2. **スプリント移動**: 週次で優先タスクを sprint.mdc へコピー
3. **状態更新**: コミット時に [ ]→[x] & Health✅
4. **アーカイブ移行**: 
   - 完了タスクは3ヵ月経過で sprint.mdc から archive.mdc へ移動
   - 完了したがスキップまたは置き換えられたタスクも archive.mdc に移動し、Notes に置き換え理由や関連タスク（例: 「TST-012 に置き換えられました」）を明記
5. **トレーサビリティの確保**:
   - タスクがマージや再編成される場合、元のタスクを削除する前に archive.mdc に移動
   - 関連タスクとの紐付けを Notes に明記（例: 「TST-012として再実装」「ALG-040に機能統合」など）
   - スプリントから直接削除せず、必ず archive.mdc へのトレース情報を残す

## 6. Git 運用 Tips

- PR テンプレートに Fixes TASK‑ID を必ず入れて紐付け
- GitHub Actions で Todoタスク形式チェック
- PR タイトルに「XXX-000: 変更内容」の形式でタスクIDを含める

## 7. CI/CD連携

- GitHub Actions CI/CDパイプラインとの連携
  - PR作成時のTodoタスクID参照必須チェック
  - Todoファイル更新時のフォーマットチェック
  - マージ時のタスク状態自動更新

## 8. 自動化ワークフロー

### GitHub Actions によるタスク状態自動更新

PRマージ時に対応するタスクを自動的に完了状態に更新します:

1. PRタイトルまたは本文からタスクID（例: `ALG-001`）を抽出
2. `.todo/sprint.mdc` と `.todo/backlog.mdc` からタスクを検索
3. 見つかったタスクを以下のように更新:
   - チェックボックスを `[ ]` から `[x]` に変更
   - `🩺 Health` を `✅` に更新
   - `📊 Progress` を `100%` に更新
4. 変更を自動コミット

### Todoフォーマットチェック

Todoファイル更新時に以下の検証を実行:

- ラベル必須チェック
- タスクIDフォーマットチェック
- 進捗状況フォーマットチェック
- 期限日付フォーマットチェック
- ヘルスステータスチェック
- オーナー必須チェック
- 済タスクのHealth/Progress確認

## 9. Todo-lint ツール

### Todo-lint 実行方法

```bash
# 全ての検証を実行
npm run todo-lint

# 実装済みオプション
npm run todo-lint -- --quiet          # エラーのみ出力（成功メッセージを表示しない）
npm run todo-lint -- --format=json    # JSON形式で出力
npm run todo-lint -- --fix            # 自動修正可能な問題を修正（フレームワークのみ実装済み）

# 複数オプションの組み合わせ
npm run todo-lint -- --quiet --format=json  # 静かにJSON形式で出力
```

### 検証項目

Todo-lintツールは以下の検証を行います：

1. **タスクID重複検出** - 同じIDを持つタスクがないか確認
2. **進捗/Health不整合** - 進捗率とHealthステータスの整合性確認
   - 完了マークされたタスクは進捗率100%かつHealthが✅であるべき
   - 未完了タスクで進捗率100%の場合はHealthも✅であるべき
3. **期限切れ検出** - 未完了タスクの期限切れを検出
4. **依存参照整合性** - Depends-onフィールドが存在するタスクIDを参照しているか確認
5. **必須フィールド確認** - Due、Owner、Label、Health、Progressなどの必須フィールドが設定されているか確認
6. **タスクID形式検証** - 「XXX-000」の形式（3文字カテゴリ+3桁数字）に適合しているか確認
7. **進捗率形式検証** - 標準形式（0%、25%、50%、75%、100%）に加え、10%や33%などの柔軟な進捗率形式にも対応
8. **Health状態検証** - Healthが⏳、⚠️、🚑、✅のいずれかであるか確認
9. **削除タスク追跡** - 削除/置換されたタスクがアーカイブに適切に記録されているか確認

### 出力例

```
🔍 C:\Users\nijor\Dev\SOL_bot\.todo のTodoタスクを検証中...

❌ 5件の問題が見つかりました:

【タスクID重複】- 1件
  • backlog.mdc:10 - タスクID ALG-031 が重複しています。別の場所: C:\Users\nijor\Dev\SOL_bot\.todo\archive.mdc:123

【進捗率形式不正】- 2件
  • backlog.mdc:35 - タスク ALG-037 の進捗率形式が不正です: 10%、有効値: 0%, 25%, 50%, 75%, 100%
  • backlog.mdc:43 - タスク TST-004 の進捗率形式が不正です: 5%、有効値: 0%, 25%, 50%, 75%, 100%

【期限切れ】- 2件
  • backlog.mdc:511 - タスク INF-021 の期限が過ぎています: 2024-03-15
  • backlog.mdc:519 - タスク DOC-007 の期限が過ぎています: 2024-03-20
```

## 10. データ処理機能

最近実装された機能:

### マルチタイムフレームデータ取得

`MultiTimeframeDataFetcher` クラスは複数の時間足でデータ取得を行います:

- 対応時間足: 1分足(1m), 15分足(15m), 1時間足(1h), 日足(1d)
- 取得元取引所: Binance, KuCoin, Bybit
- スケジュール実行: 各時間足に適したcron式でスケジュール
- 実行方法: 
  ```
  npm run fetch-data:all     # 全時間足取得
  npm run fetch-data:1m      # 1分足のみ取得
  npm run fetch-data:15m     # 15分足のみ取得
  npm run fetch-data:1h      # 1時間足のみ取得
  npm run fetch-data:1d      # 日足のみ取得
  npm run start-data-service # 定期取得サービス開始
  ```

### Parquet形式データストア

`ParquetDataStore` はデータの効率的な保存と取得を担当:

- 高圧縮・高速アクセスのParquet形式でのデータ永続化
- DuckDBによる高速クエリ処理
- 複数の時間足データ対応
- タイムスタンプ範囲指定クエリ
- マルチタイムフレーム対応の最新データ取得API 

## 11. タスク管理の推奨実践

1. **スプリント移行時のタスク整理**:
   - スプリント間移行時は、未完了タスクは次のスプリントへ移動
   - 完了タスクはスプリントに維持し、3ヶ月後にarchiveへ移動
   - 計画変更で不要になったタスクはarchiveへ移動し、理由を記録

2. **タスク削除の代替アプローチ**:
   - タスクを直接削除するのではなく、archiveへ移動して履歴を保持
   - 重複タスク、統合タスク、リネームされたタスクも全てarchiveへ
   - 移行時は必ず関連タスクIDを記録（例: 「TST-011はTST-012に統合」）

3. **タスク追跡性の改善**:
   - Notesに変更の経緯や統合情報を記録
   - バックアップだけでなく、明示的な履歴としてarchiveを活用
   - 「なぜこのタスクが変更されたか」の理由も残すことを推奨 